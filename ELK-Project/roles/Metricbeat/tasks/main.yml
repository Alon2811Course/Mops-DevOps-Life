---

- hosts: all
  gather_facts: False
  remote_user: ubuntu
  become: yes
  become_user: root
  become_method: sudo
  
  tasks:  

    - name: Create Folder for Metricbeat
      file:
        path: /opt/metricbeat/metricbeat-6.5.4-linux-x86_64
        state: directory
        mode: u+rwx
        
    - name: Change Owner
      file:
        path: /opt/metricbeat/metricbeat-6.5.4-linux-x86_64
        recurse: yes
        owner: root
        group: root
        mode: u+rwx
      

    - name: Download Metricbeat
      raw: curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-6.5.4-linux-x86_64.tar.gz
  
    - name: Unzip Metricbeat
      raw: tar -C /opt/metricbeat -xzvf metricbeat-6.5.4-linux-x86_64.tar.gz
      
    - name: Change the ELK output IP
      raw: sed -i 's/localhost:9200/{elk_host}:9200/g' /opt/metricbeat/metricbeat-6.5.4-linux-x86_64/metricbeat.yml
      
    - name: Start Metricbeat
      raw: cd /opt/metricbeat/metricbeat-6.5.4-linux-x86_64 && ./metricbeat -e
    
